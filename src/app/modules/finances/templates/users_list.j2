{% extends "layout.j2" %}


{% block extra_head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static_finance', path='css/user_list.css') }}">
{% endblock %}


{% block finance_content %}
<section class="management-section">
    <div class="grid">
        <article class="user-card-container">
            <header class="card-header">
                <strong>Perfis Ativos</strong>
            </header>

            <div class="user-list">
                {% for user in users %}
                <a href="/finance/user/{{ user.id }}/accounts" class="profile-item-link">
                    <div class="profile-info">
                        <strong class="profile-name">{{ user.name }}</strong>
                        <small class="phone-display">{{ user.id }}</small>
                    </div>
                    <span class="action-icon">➔</span>
                </a>
                {% else %}
                <p class="empty-state"><i>Nenhum usuário encontrado.</i></p>
                {% endfor %}
            </div>
        </article>

        <article class="form-card-container">
            <header class="card-header">
                <strong>Novo Perfil</strong>
            </header>

            <form action="/api/internal/finance/users" method="post" class="profile-form">
                <div class="form-group">
                    <label for="name">Nome do Usuário</label>
                    <input type="text" id="name" name="name" placeholder="Ex: Admin" required>
                </div>

                <div class="form-group">
                    <label for="phone_mask">WhatsApp (DDI + DDD)</label>
                    <input type="tel" id="phone_mask" placeholder="+55 (11) 99999-9999" required {% if error
                        %}aria-invalid="true" {% endif %}>

                    {% if error %}
                    <div class="error-message">
                        {{ error }}
                    </div>
                    {% endif %}
                </div>

                <input type="hidden" id="jid_clean" name="jid">
                <button type="submit" class="btn-create contrast">Criar Perfil</button>
            </form>
        </article>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const phoneInput = document.getElementById('phone_mask');
    const hiddenInput = document.getElementById('jid_clean');

    phoneInput.addEventListener('input', function (e) {
        // Remove tudo que não é número para o banco
        let x = e.target.value.replace(/\D/g, '');
        hiddenInput.value = x;

        // Formatação visual: +55 (11) 99999-9999
        let formatted = "";
        if (x.length > 0) {
            formatted = "+" + x.substring(0, 2);
            if (x.length > 2) formatted += " (" + x.substring(2, 4) + ")";
            if (x.length > 4) formatted += " " + x.substring(4, 9);
            if (x.length > 9) formatted += "-" + x.substring(9, 13);
        }
        e.target.value = formatted;
    });

    // Formata os números já existentes na lista ao carregar a página
    document.querySelectorAll('.phone-display').forEach(el => {
        let x = el.innerText.replace(/\D/g, '');
        if (x.length >= 12) {
            el.innerText = `+${x.substring(0, 2)} (${x.substring(2, 4)}) ${x.substring(4, 9)}-${x.substring(9, 13)}`;
        }
    });
</script>
{% endblock %}