{% extends "layout.j2" %}
{% from "macros/account_card.j2" import account_card %}

{% block extra_head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static_finance', path='css/accounts.css') }}">
{% endblock %}

{% block finance_content %}
<section class="accounts-section">
    <header class="section-header">
        <hgroup>
            <h1>Contas Banc√°rias</h1>
            <p>Gerenciando acessos de <strong>{{ user.name }}</strong></p>
        </hgroup>

        <details role="list" class="add-account-menu">
            <summary aria-haspopup="listbox" role="link" class="contrast">
                Vincular Conta
            </summary>
            <ul role="listbox">
                {% for acc in available_accounts %}
                <li>
                    <a href="#" onclick="linkAccount('{{ user.id }}', '{{ acc.id }}')">
                        {{ acc.name }}
                    </a>
                </li>
                {% else %}
                <li><small>Nenhuma conta dispon√≠vel</small></li>
                {% endfor %}
            </ul>
        </details>
    </header>

    <div class="accounts-grid">
        {% for acc in owned_accounts %}
        {{ account_card(acc, user.id) }}
        {% else %}
        <article class="empty-accounts">
            <div class="empty-icon">üè¶</div>
            <p>Nenhuma conta vinculada a este perfil.</p>
        </article>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    // As fun√ß√µes de JS permanecem aqui, pois s√£o espec√≠ficas da l√≥gica desta p√°gina
    async function editBalance(accId, currentVal) {
        const newVal = prompt("Novo saldo inicial:", currentVal);
        if (newVal !== null && newVal !== currentVal) {
            const res = await fetch(`/api/internal/finance/accounts/${accId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initial_balance: newVal })
            });
            if (res.ok) location.reload();
        }
    }

    async function linkAccount(userId, accId) {
        await fetch(`/api/internal/finance/user/${userId}/link/${accId}`, { method: 'POST' });
        location.reload();
    }

    async function unlinkAccount(userId, accId) {
        if (confirm("Remover v√≠nculo desta conta?")) {
            await fetch(`/api/internal/finance/user/${userId}/unlink/${accId}`, { method: 'DELETE' });
            location.reload();
        }
    }
</script>
{% endblock %}