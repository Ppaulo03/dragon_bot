{% extends "layout.j2" %}
{% from "macros/transaction_card.j2" import transaction_card %}

{% block extra_head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static_finance', path='css/transaction_filters.css') }}">
<link rel="stylesheet" href="{{ url_for('static_finance', path='css/transactions.css') }}">
<link rel="stylesheet" href="{{ url_for('static_finance', path='css/transaction_card.css') }}">
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<style>
    /* Feedback visual de carregamento */
    .htmx-request #transactions-container {
        opacity: 0.5;
        filter: blur(1px);
        transition: all 0.2s ease;
    }
</style>
{% endblock %}

{% block finance_content %}
<section>
    <article class="filter-card">
        <form id="filter-form" method="get" action="/finance/user/{{ user.id }}/transactions" class="filter-grid"
            hx-get="/finance/user/{{ user.id }}/transactions" hx-target="#transactions-wrapper"
            hx-select="#transactions-wrapper"
            hx-trigger="keyup delay:500ms from:#search-input, change from:select, change from:input[type='date']"
            hx-push-url="true">

            <div class="form-group search-group">
                <label for="search-input">Buscar</label>
                <input type="search" name="q" id="search-input" value="{{ current_q }}" placeholder="Descri칞칚o...">
            </div>

            <div class="form-group">
                <label for="account-select">Conta</label>
                <select name="account_id" id="account-select">
                    <option value="">Todas</option>
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}" {% if current_acc==acc.id|string %}selected{% endif %}>{{ acc.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="type-select">Tipo</label>
                <select name="type" id="type-select">
                    <option value="">Todos</option>
                    <option value="income" {% if current_type=='INFLOW' %}selected{% endif %}>Entrada</option>
                    <option value="expense" {% if current_type=='OUTFLOW' %}selected{% endif %}>Sa칤da</option>
                </select>
            </div>

            <div class="form-group">
                <label for="origin-select">Origem</label>
                <select name="manual" id="origin-select">
                    <option value="">Todas</option>
                    <option value="true" {% if current_manual=='true' %}selected{% endif %}>Manual</option>
                    <option value="false" {% if current_manual=='false' %}selected{% endif %}>Autom치tica</option>
                </select>
            </div>

            <div class="form-group">
                <label for="start-date">In칤cio</label>
                <input type="date" name="start_date" id="start-date" value="{{ current_start_date }}">
            </div>

            <div class="form-group">
                <label for="end-date">Fim</label>
                <input type="date" name="end_date" id="end-date" value="{{ current_end_date }}">
            </div>

            <input type="hidden" name="page" value="1">
        </form>
    </article>

    <div id="transactions-wrapper" class="fade-in">
        <div id="transactions-container" class="transactions-list">
            {% for tx in transactions %}
            {{ transaction_card(tx, cat_lv1) }}
            {% else %}
            <article class="empty-state">
                <div class="empty-icon">游댌</div>
                <p>Nenhuma transa칞칚o encontrada para os filtros aplicados.</p>
                <a href="/finance/user/{{ user.id }}/transactions" class="btn-clear-filters outline secondary">
                    Limpar todos os filtros
                </a>
            </article>
            {% endfor %}
        </div>

        {% if total_pages > 1 %}
        <nav class="pagination-container" aria-label="pagination">
            {% set clean_url = "/finance/user/" ~ user.id ~ "/transactions" %}

            {% if current_page > 1 %}
            <a href="{{ clean_url }}?page={{ current_page - 1 }}" hx-get="{{ clean_url }}?page={{ current_page - 1 }}"
                hx-include="#filter-form" hx-params="not page" hx-target="#transactions-wrapper"
                hx-select="#transactions-wrapper" hx-swap="innerHTML" hx-push-url="true" role="button"
                class="btn-pagination outline">
                춺 Anterior
            </a>
            {% endif %}

            <div class="pagination-selector">
                <span>P치gina</span>
                <select name="page" hx-get="{{ clean_url }}" hx-include="#filter-form" {# O SEGREDO: hx-vals garante que
                    este valor 'atropela' o do formul치rio #} hx-vals='js:{page: event.target.value}'
                    hx-target="#transactions-wrapper" hx-select="#transactions-wrapper" hx-swap="innerHTML"
                    hx-push-url="true" hx-trigger="change">
                    {% for p in range(1, total_pages + 1) %}
                    <option value="{{ p }}" {% if p==current_page %}selected{% endif %}>
                        {{ p }}
                    </option>
                    {% endfor %}
                </select>
                <span>de {{ total_pages }}</span>
            </div>

            {% if current_page < total_pages %} <a href="{{ clean_url }}?page={{ current_page + 1 }}"
                hx-get="{{ clean_url }}?page={{ current_page + 1 }}" hx-include="#filter-form" hx-params="not page"
                hx-target="#transactions-wrapper" hx-select="#transactions-wrapper" hx-swap="innerHTML"
                hx-push-url="true" role="button" class="btn-pagination outline">
                Pr칩xima 췉
                </a>
                {% endif %}
        </nav>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const categoryTree = {{ categories_json | safe }};
</script>
<script src="{{ url_for('static_finance', path='js/transaction_card.js') }}"></script>
<script src="{{ url_for('static_finance', path='js/transactions_list.js') }}"></script>
{% endblock %}