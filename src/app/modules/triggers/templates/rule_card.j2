{% macro render_rule_card(t, section, options, idx, storage_url) %}
{% set chance = t.get('chance', 1.0) %}
{% set name = t.get('name', '') %}
{% set type = t.get('type', 'send_text') %}
{% set matcher = t.get('matcher', 'exact') if section == 'trigger' else 'always' %}
{% set params = t.get('params', {}) or {} %}
{% set value = t.get('value', '') %}
{% set files = t.get('files', []) %}
{% set action = t.get('action', '') %}

{% set card_id = t.id if t.id else 'new_' ~ idx %}

<article class="rule-card collapsed" data-section="{{ section }}" id="card-{{ idx }}">
    <header class="card-header">
        <span class="collapse-icon">â–¼</span>
        <input type="text" name="name_{{ card_id }}" value="{{ name }}" class="input-rule-name"
            placeholder="Nome da Regra" required onclick="event.stopPropagation()">

        <div class="header-right-actions">
            <button type="button" class="btn-delete" title="Excluir Regra"
                onclick="event.stopPropagation(); this.closest('article').remove()">âœ–</button>
        </div>
    </header>

    <div class="card-body">
        <div class="grid-options">
            <label>Tipo
                <select name="type_{{ card_id }}">
                    {% for op in options.response_types %}
                    <option value="{{ op }}" {{ 'selected' if op==type }}>{{ op }}</option>
                    {% endfor %}
                </select>
            </label>

            {% if section == 'trigger' %}
            <label>Matcher
                <select name="matcher_{{ card_id }}">
                    {% for m in options.matchers if m != 'always' %}
                    <option value="{{ m }}" {{ 'selected' if m==matcher }}>{{ m }}</option>
                    {% endfor %}
                </select>
            </label>
            {% endif %}

            <div class="chance-container">
                <label>Chance (<span class="chance-display">{{ "%.1f"|format(chance * 100) }}%</span>)</label>
                <div class="chance-input-wrapper">
                    <input type="range" name="chance_{{ card_id }}" value="{{ chance }}" min="0" max="1" step="0.001">
                </div>
            </div>
        </div>

        <section class="dynamic-zones">

            <div data-zone="matcher-text" class="zone-container">
                <label>PadrÃ£o (Texto ou Regex)</label>
                <input type="text" name="pattern_{{ card_id }}" value="{{ params.get('pattern', '') }}"
                    placeholder="Ex: oi|olÃ¡|bom dia">
            </div>

            <div data-zone="matcher-image" class="zone-container">
                <label>Imagem de ReferÃªncia (Similarity)</label>
                <input type="file" name="trigger_file_upload_{{ card_id }}" accept="image/*">
                <input type="hidden" name="pattern_{{ card_id }}" value="{{ params.get('pattern', '') }}">
                <input type="hidden" name="hash_{{ card_id }}" value="{{ params.get('hash', '') }}">

                <div class="preview-box mini-preview" id="preview-trig-{{ card_id }}">
                    {% if params.get('pattern', '') %}
                    <img src="{{ storage_url }}{{ params.get('pattern', '') }}" class="img-ref-preview">
                    {% endif %}
                </div>
            </div>

            <div data-zone="mode-selector" class="response-selector">
                <label>
                    <input type="radio" name="mode_{{ card_id }}" value="text" {{ 'checked' if not action }}>
                    <span>Direto</span>
                </label>
                <label>
                    <input type="radio" name="mode_{{ card_id }}" value="api" {{ 'checked' if action }}>
                    <span>API Externa</span>
                </label>
            </div>

            <div data-zone="input-api" class="zone-container">
                <label>AÃ§Ã£o da API</label>
                <select name="action_{{ card_id }}">
                    {% for act in options.actions %}
                    <option value="{{ act }}" {{ 'selected' if action==act }}>{{ act }}</option>
                    {% endfor %}
                </select>
            </div>

            <div data-zone="input-text" class="zone-container">
                <label>Texto da Resposta</label>
                <textarea name="value_{{ card_id }}"
                    placeholder="Digite a mensagem que o bot enviarÃ¡...">{{ value }}</textarea>
            </div>

            <div data-zone="input-file" class="zone-container">
                <label>Arquivos Anexados (Audios, Imagens, Stickers)</label>
                <input type="file" name="file_upload_{{ card_id }}" multiple>

                <div class="preview-box sutil-preview" id="preview-dest-{{ card_id }}">
                    {% if files and files is iterable and files is not string %}
                    {% for path in files %}
                    {% set file_name = path.split('/')[-1] %}
                    {% set ext = path.split('.')[-1].lower() %}
                    <div class="preview-item" data-path="{{ path }}" data-file-name="{{ file_name }}">
                        {% if ext in ['png', 'jpg', 'jpeg', 'gif', 'webp'] %}
                        <img src="{{ storage_url }}{{ path }}" class="asset-preview-img">
                        {% else %}
                        <div class="asset-preview-icon">
                            <span>{{ 'ðŸŽµ' if ext in ['mp3', 'ogg', 'wav', 'm4a'] else 'ðŸ“„' }}</span>
                        </div>
                        {% endif %}
                        <input type="hidden" name="keep_files_{{ card_id }}" value="{{ path }}">
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                {% if not files %}
                <small class="no-files-msg">Nenhum arquivo anexado no storage.</small>
                {% endif %}
            </div>

        </section>

        <input type="hidden" name="rule_id" value="{{ card_id }}">
        <input type="hidden" name="section_{{ card_id }}" value="{{ section }}">
    </div>
</article>
{% endmacro %}