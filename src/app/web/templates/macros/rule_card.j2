{% macro render_rule_card(t, section, options, idx, storage_url) %}
{% set chance = t.get('chance', 1.0) %}
{% set name = t.get('name', '') %}
{% set type = t.get('type', 'send_text') %}
{% set matcher = t.get('matcher', 'exact') if section == 'trigger' else 'always' %}
{% set params = t.get('params', {}) or {} %}
{% set value = t.get('value', '') %}
{% set files = t.get('files', []) %}
{% set action = t.get('action', '') %}

{% set card_id = t.id if t.id else 'new_' ~ idx %}

<article class="rule-card collapsed" data-section="{{ section }}" id="card-{{ idx }}">
    <header class="card-header">
        <span class="collapse-icon">‚ñº</span>
        <input type="text" name="name_{{ card_id }}" value="{{ name }}" placeholder="Nome da Regra" required
            onclick="event.stopPropagation()">
        <button type="button" class="btn-delete"
            onclick="event.stopPropagation(); this.closest('article').remove()">‚úñ</button>
    </header>

    <div class="card-body">
        <div class="grid">
            <label>
                Tipo
                <select name="type_{{ card_id }}">
                    {% for op in options.response_types %}
                    <option value="{{ op }}" {{ 'selected' if op==type }}>{{ op }}</option>
                    {% endfor %}
                </select>
            </label>

            {% if section == 'trigger' %}
            <label>Matcher
                <select name="matcher_{{ card_id }}">
                    {% for m in options.matchers if m != 'always' %}
                    <option value="{{ m }}" {{ 'selected' if m==matcher }}>{{ m }}</option>
                    {% endfor %}
                </select>
            </label>
            {% endif %}

            <div>
                <label>Chance (<span class="chance-display">{{ "%.1f"|format(chance * 100) }}%</span>)
                    <input type="range" name="chance_{{ card_id }}" value="{{ chance }}" min="0" max="1" step="0.001">
                </label>
            </div>
        </div>

        <section class="dynamic-zones">
            <div data-zone="matcher-text">
                <label>Padr√£o (Texto/Regex)</label>
                <input type="text" name="pattern_{{ card_id }}" value="{{ params.get('pattern', '') }}">
            </div>

            <div data-zone="matcher-image">
                <label>Imagem de Refer√™ncia</label>
                <input type="file" name="trigger_file_upload_{{ card_id }}" accept="image/*">
                <input type="hidden" name="pattern_{{ card_id }}" value="{{ params.get('pattern', '') }}">
                <input type="hidden" name="hash_{{ card_id }}" value="{{ params.get('hash', '') }}">
                <div class="preview-box mini-preview" id="preview-trig-{{ card_id }}"
                    data-path="{{ storage_url }}{{ params.get('pattern', '') }}">
                    {% if params.get('pattern', '') %}
                    <img src="{{ storage_url }}{{ params.get('pattern', '') }}" style="max-height: 80px;">
                    {% endif %}
                </div>
            </div>

            <div data-zone="mode-selector" class="response-selector">
                <label><input type="radio" name="mode_{{ card_id }}" value="text" {{ 'checked' if not action }}>
                    Direto</label>
                <label><input type="radio" name="mode_{{ card_id }}" value="api" {{ 'checked' if action }}> API</label>
            </div>

            <div data-zone="input-api">
                <label>A√ß√£o da API</label>
                <select name="action_{{ card_id }}">
                    {% for act in options.actions %}
                    <option value="{{ act }}" {{ 'selected' if action==act }}>{{ act }}</option>
                    {% endfor %}
                </select>
            </div>

            <div data-zone="input-text">
                <label>Resposta de Texto</label>
                <textarea name="value_{{ card_id }}" placeholder="Texto da resposta">{{ value }}</textarea>
            </div>

            <div data-zone="input-file">
                <label>Arquivos</label>

                <input type="file" name="file_upload_{{ card_id }}" multiple>

                <div class="preview-box sutil-preview" id="preview-dest-{{ card_id }}">
                    {# --- 1. ARQUIVOS QUE J√Å EXISTEM NO STORAGE --- #}
                    {% if files and files is iterable and files is not string %}
                    {% for path in files %}
                    {% set file_name = path.split('/')[-1] %}
                    {% set ext = path.split('.')[-1].lower() %}
                    <div class="preview-item" id="file-{{ loop.index }}-{{ idx }}" data-path="{{ path }}"
                        data-file-name="{{ file_name }}" title="{{ file_name }}"
                        style="position: relative; display: inline-block; cursor: pointer;">

                        {% if ext in ['png', 'jpg', 'jpeg', 'gif', 'webp'] %}
                        <img src="{{ storage_url }}{{ path }}"
                            style="height: 60px; width: 60px; object-fit: cover; border-radius: 4px; pointer-events: none;">
                        {% else %}
                        <div
                            style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 4px; pointer-events: none;">
                            <span>{{ 'üéµ' if ext in ['mp3', 'ogg', 'wav'] else 'üìÑ'
                                }}</span>
                        </div>
                        {% endif %}
                        <input type="hidden" name="keep_files_{{ card_id }}" value="{{ path }}">
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                {% if not files %}
                <small class="text-muted no-files-msg" style="font-size: 0.7rem;">Nenhum arquivo
                    anexado</small>
                {% endif %}
            </div>

        </section>

        <input type="hidden" name="rule_id" value="{{ card_id }}">
        <input type="hidden" name="section_{{ card_id }}" value="{{ section }}">
    </div>
</article>
{% endmacro %}